<!DOCTYPE html>
<html>
<head>
    <title>Property Reports - Buy Reports</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; }
        .property-card { border: 1px solid #ddd; border-radius: 10px; padding: 20px; margin: 20px 0; background: #f9f9f9; }
        .property-info { margin-bottom: 15px; }
        .property-name { font-size: 18px; font-weight: bold; color: #333; }
        .property-address { color: #666; margin: 5px 0; }
        .price { font-size: 16px; font-weight: bold; color: #007cba; }
        .buy-btn { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .buy-btn:hover { background: #005a87; }
        .cart { background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #ddd; }
        .remove-btn { background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; }
        .checkout-btn { background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; margin-top: 20px; }
        .checkout-btn:hover { background: #218838; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .pricing-info { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè† Property Reports</h1>
        <p>Get detailed rating reports for properties you're interested in</p>
    </div>

    <!-- Sample Properties -->
    <div class="property-card">
        <div class="property-info">
            <div class="property-name">10634 Merriman Road</div>
            <div class="property-address">Cupertino, CA 95014</div>
            <div class="price">$10.00 per report</div>
        </div>
        <button class="buy-btn" onclick="addToCart('364607cd-69fb-4e8a-9b20-4ff4ce6758e7', '10634 Merriman Road', 'Cupertino, CA 95014')">
            üìä Add Report to Cart
        </button>
    </div>

    <!-- Shopping Cart -->
    <div class="cart" id="cart" style="display: none;">
        <h3>üõí Your Cart</h3>
        <div id="cart-items"></div>
        
        <div class="pricing-info">
            <h4>üí∞ Pricing:</h4>
            <ul>
                <li>1st report: $10.00</li>
                <li>2nd report: $9.60 (4% discount)</li>
                <li>3rd report: $9.20 (8% discount)</li>
                <li>Each additional: $0.40 less (minimum $1.00)</li>
            </ul>
        </div>

        <div class="form-group">
            <label for="email">Email Address:</label>
            <input type="email" id="email" placeholder="your.email@example.com" required>
        </div>
        
        <div class="form-group">
            <label for="name">Full Name:</label>
            <input type="text" id="name" placeholder="John Doe" required>
        </div>

        <div id="total"></div>
        
        <button class="checkout-btn" onclick="proceedToCheckout()">
            üöÄ Proceed to Secure Checkout
        </button>
    </div>

    <script>
        let cart = [];

        function addToCart(propertyId, name, address) {
            // Check if already in cart
            if (cart.find(item => item.propertyId === propertyId)) {
                alert('This property is already in your cart!');
                return;
            }

            cart.push({ propertyId, name, address });
            updateCartDisplay();
        }

        function removeFromCart(propertyId) {
            cart = cart.filter(item => item.propertyId !== propertyId);
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartDiv = document.getElementById('cart');
            const cartItems = document.getElementById('cart-items');
            const totalDiv = document.getElementById('total');

            if (cart.length === 0) {
                cartDiv.style.display = 'none';
                return;
            }

            cartDiv.style.display = 'block';

            // Calculate pricing
            const basePrice = 10.00;
            const discountPerItem = 0.40;
            let total = 0;
            let html = '';

            cart.forEach((item, index) => {
                const price = Math.max(basePrice - (index * discountPerItem), 1.00);
                total += price;
                
                html += `
                    <div class="cart-item">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${item.address}</small>
                        </div>
                        <div>
                            <span>$${price.toFixed(2)}</span>
                            <button class="remove-btn" onclick="removeFromCart('${item.propertyId}')">Remove</button>
                        </div>
                    </div>
                `;
            });

            cartItems.innerHTML = html;
            totalDiv.innerHTML = `<div style="font-size: 18px; font-weight: bold; text-align: center; margin: 15px 0;">Total: $${total.toFixed(2)}</div>`;
        }

        async function proceedToCheckout() {
            const email = document.getElementById('email').value;
            const name = document.getElementById('name').value;

            if (!email || !name) {
                alert('Please fill in your email and name');
                return;
            }

            if (cart.length === 0) {
                alert('Your cart is empty');
                return;
            }

            const propertyIds = cart.map(item => item.propertyId);

            try {
                // Show loading
                const checkoutBtn = document.querySelector('.checkout-btn');
                checkoutBtn.textContent = '‚è≥ Creating checkout session...';
                checkoutBtn.disabled = true;

                const response = await fetch('http://localhost:3001/create-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        propertyIds: propertyIds,
                        email: email,
                        customerName: name
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Redirect to Stripe checkout
                    window.location.href = result.checkout_url;
                } else {
                    alert('Checkout failed: ' + result.error);
                    checkoutBtn.textContent = 'üöÄ Proceed to Secure Checkout';
                    checkoutBtn.disabled = false;
                }
            } catch (error) {
                alert('Connection error: ' + error.message);
                checkoutBtn.textContent = 'üöÄ Proceed to Secure Checkout';
                checkoutBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
